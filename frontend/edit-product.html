<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Edit your listing - Sellout Campus Marketplace">
    <title>Edit Listing | Sellout</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="css/style.css?v=5">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
</head>

<body class="bg-gray-50 text-gray-800 font-sans min-h-screen">
    <!-- Navigation -->
    <nav class="fixed top-0 left-0 right-0 bg-white/80 backdrop-blur-xl border-b border-gray-100 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <a href="index.html" class="flex items-center gap-2">
                    <img src="assets/logo.png" alt="Sellout Logo" class="h-10 w-10 rounded-xl object-contain bg-green-600 p-1.5">
                    <span class="text-xl font-bold text-gray-900">Sellout</span>
                </a>
                <a href="profile.html" class="text-sm text-gray-500 hover:text-gray-900 transition-colors">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Profile
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="pt-24 pb-16">
        <div class="max-w-2xl mx-auto px-4 sm:px-6 lg:px-8">
            <!-- Loading State -->
            <div id="loadingState" class="animate-pulse space-y-6">
                <div class="h-10 bg-gray-100 rounded w-1/2 mx-auto"></div>
                <div class="h-64 bg-gray-100 rounded-2xl"></div>
                <div class="h-48 bg-gray-100 rounded-2xl"></div>
            </div>

            <!-- Edit Form -->
            <div id="editContent" class="hidden">
                <!-- Header -->
                <div class="text-center mb-10">
                    <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-green-50 mb-4">
                        <i class="fas fa-edit text-3xl text-green-600"></i>
                    </div>
                    <h1 class="text-3xl font-bold mb-2 text-gray-900">Edit Listing</h1>
                    <p class="text-gray-400">Update your item details</p>
                </div>

                <!-- Form -->
                <form id="editForm" class="space-y-6">
                    <input type="hidden" id="productId">

                    <!-- Current Image -->
                    <div class="p-6 rounded-2xl bg-white border border-gray-100 shadow-sm">
                        <label class="block text-sm font-medium text-gray-600 mb-3">Product Image</label>
                        <div id="imageUploadArea"
                            class="relative border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-green-400 transition-all cursor-pointer">
                            <input type="file" id="imageInput" name="image"
                                accept="image/jpeg,image/jpg,image/png,image/webp"
                                class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                            <div id="imagePreview">
                                <img src="" alt="Current image" id="currentImage" class="max-h-64 mx-auto rounded-lg">
                                <p class="text-xs text-gray-400 mt-3">Click or drag to replace image</p>
                            </div>
                        </div>
                    </div>

                    <!-- Product Details -->
                    <div class="p-6 rounded-2xl bg-white border border-gray-100 shadow-sm space-y-5">
                        <h3 class="font-semibold text-lg text-gray-900">Product Details</h3>

                        <!-- Title -->
                        <div>
                            <label for="title" class="block text-sm font-medium text-gray-600 mb-2">Title *</label>
                            <input type="text" id="title" name="title" required maxlength="200"
                                class="w-full bg-gray-50 border border-gray-300 rounded-xl py-3 px-4 text-sm text-gray-800 placeholder-gray-400 focus:outline-none focus:border-green-500 focus:ring-2 focus:ring-green-500/20 transition-all">
                        </div>

                        <!-- Category & Condition -->
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="category" class="block text-sm font-medium text-gray-600 mb-2">Category
                                    *</label>
                                <select id="category" name="category" required
                                    class="w-full bg-gray-50 border border-gray-300 rounded-xl py-3 px-4 text-sm text-gray-700 focus:outline-none focus:border-green-500 focus:ring-2 focus:ring-green-500/20 transition-all">
                                    <option value="Books">Books</option>
                                    <option value="Electronics">Electronics</option>
                                    <option value="Fashion">Fashion</option>
                                    <option value="Furniture">Furniture</option>
                                    <option value="Others">Others</option>
                                </select>
                            </div>
                            <div>
                                <label for="condition" class="block text-sm font-medium text-gray-600 mb-2">Condition
                                    *</label>
                                <select id="condition" name="condition" required
                                    class="w-full bg-gray-50 border border-gray-300 rounded-xl py-3 px-4 text-sm text-gray-700 focus:outline-none focus:border-green-500 focus:ring-2 focus:ring-green-500/20 transition-all">
                                    <option value="New">New</option>
                                    <option value="Fairly Used">Fairly Used</option>
                                    <option value="Used">Used</option>
                                </select>
                            </div>
                        </div>

                        <!-- Price & Status -->
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="price" class="block text-sm font-medium text-gray-600 mb-2">Price (₵)
                                    *</label>
                                <div class="relative">
                                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">₵</span>
                                    <input type="number" id="price" name="price" required min="0" step="0.01"
                                        class="w-full bg-gray-50 border border-gray-300 rounded-xl py-3 pl-10 pr-4 text-sm text-gray-800 placeholder-gray-400 focus:outline-none focus:border-green-500 focus:ring-2 focus:ring-green-500/20 transition-all">
                                </div>
                            </div>
                            <div>
                                <label for="status" class="block text-sm font-medium text-gray-600 mb-2">Status</label>
                                <select id="status" name="status"
                                    class="w-full bg-gray-50 border border-gray-300 rounded-xl py-3 px-4 text-sm text-gray-700 focus:outline-none focus:border-green-500 focus:ring-2 focus:ring-green-500/20 transition-all">
                                    <option value="available">Available</option>
                                    <option value="sold">Sold</option>
                                </select>
                            </div>
                        </div>

                        <!-- Campus -->
                        <div>
                            <label for="campus" class="block text-sm font-medium text-gray-600 mb-2">Campus
                                Location</label>
                            <div class="relative">
                                <input type="text" id="campus" name="campus"
                                    class="w-full bg-gray-50 border border-gray-300 rounded-xl py-3 pl-11 pr-4 text-sm text-gray-800 placeholder-gray-400 focus:outline-none focus:border-green-500 focus:ring-2 focus:ring-green-500/20 transition-all">
                                <i
                                    class="fas fa-map-marker-alt absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            </div>
                        </div>

                        <!-- Description -->
                        <div>
                            <label for="description"
                                class="block text-sm font-medium text-gray-600 mb-2">Description</label>
                            <textarea id="description" name="description" rows="4" maxlength="2000"
                                class="w-full bg-gray-50 border border-gray-300 rounded-xl py-3 px-4 text-sm text-gray-800 placeholder-gray-400 focus:outline-none focus:border-green-500 focus:ring-2 focus:ring-green-500/20 transition-all resize-none"></textarea>
                            <p class="text-xs text-gray-400 mt-1 text-right"><span id="charCount">0</span>/2000</p>
                        </div>
                    </div>

                    <!-- Error Message -->
                    <div id="errorMessage"
                        class="hidden p-4 rounded-xl bg-red-50 border border-red-100 text-red-600 text-sm">
                        <i class="fas fa-exclamation-circle mr-2"></i>
                        <span id="errorText"></span>
                    </div>

                    <!-- Submit Buttons -->
                    <div class="flex flex-col sm:flex-row gap-4">
                        <button type="submit" id="submitBtn"
                            class="flex-1 py-3.5 rounded-xl bg-green-600 text-white font-semibold hover:bg-green-700 hover:shadow-lg hover:shadow-green-600/20 transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fas fa-save"></i>
                            <span>Save Changes</span>
                        </button>
                        <a href="#" id="cancelBtn"
                            class="py-3.5 px-6 rounded-xl border border-gray-300 text-center font-medium text-gray-700 hover:bg-gray-50 transition-all">
                            Cancel
                        </a>
                    </div>
                </form>
            </div>

            <!-- Not Found State -->
            <div id="notFoundState" class="hidden text-center py-20">
                <div class="w-20 h-20 mx-auto mb-6 rounded-2xl bg-gray-50 flex items-center justify-center">
                    <i class="fas fa-box-open text-3xl text-gray-300"></i>
                </div>
                <h2 class="text-2xl font-bold mb-2 text-gray-800">Product Not Found</h2>
                <p class="text-gray-400 mb-6">This item may have been removed or you don't have permission to edit it.
                </p>
                <a href="profile.html"
                    class="inline-flex items-center gap-2 px-6 py-3 rounded-xl bg-green-600 hover:bg-green-700 text-white font-medium transition-all">
                    <i class="fas fa-arrow-left"></i>Back to Profile
                </a>
            </div>
        </div>
    </main>

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed bottom-4 right-4 z-50 flex flex-col gap-2"></div>

    <!-- Scripts -->
    <script src="js/config.js?v=5"></script>
    <script src="js/utils.js?v=5"></script>
    <script src="js/api.js?v=5"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('token');
            if (!token) {
                showToast('Please login first', 'error');
                setTimeout(() => window.location.href = 'login.html', 1500);
                return;
            }

            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');

            if (!productId) {
                showNotFound();
                return;
            }

            await loadProduct(productId);
        });

        async function loadProduct(id) {
            try {
                const response = await api.get(`/products/${id}`);

                if (!response.success || !response.data.product) {
                    showNotFound();
                    return;
                }

                const product = response.data.product;
                const currentUser = JSON.parse(localStorage.getItem('user') || '{}');

                if (product.user_id !== currentUser.id) {
                    showNotFound();
                    return;
                }

                document.getElementById('productId').value = product.id;
                document.getElementById('currentImage').src = product.image_url;
                document.getElementById('title').value = product.title;
                document.getElementById('category').value = product.category;
                document.getElementById('condition').value = product.product_condition;
                document.getElementById('price').value = product.price;
                document.getElementById('status').value = product.status;
                document.getElementById('campus').value = product.campus;
                document.getElementById('description').value = product.description || '';
                document.getElementById('charCount').textContent = (product.description || '').length;
                document.getElementById('cancelBtn').href = `product-details.html?id=${product.id}`;

                const imageInput = document.getElementById('imageInput');
                const currentImage = document.getElementById('currentImage');

                imageInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        if (file.size > 5 * 1024 * 1024) {
                            showToast('Image must be less than 5MB', 'error');
                            imageInput.value = '';
                            return;
                        }

                        const reader = new FileReader();
                        reader.onload = (e) => {
                            currentImage.src = e.target.result;
                        };
                        reader.readAsDataURL(file);
                    }
                });

                const description = document.getElementById('description');
                const charCount = document.getElementById('charCount');
                description.addEventListener('input', () => {
                    charCount.textContent = description.value.length;
                });

                const editForm = document.getElementById('editForm');
                const submitBtn = document.getElementById('submitBtn');
                const errorMessage = document.getElementById('errorMessage');
                const errorText = document.getElementById('errorText');

                editForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    errorMessage.classList.add('hidden');

                    const formData = new FormData();
                    formData.append('title', document.getElementById('title').value.trim());
                    formData.append('category', document.getElementById('category').value);
                    formData.append('condition', document.getElementById('condition').value);
                    formData.append('price', document.getElementById('price').value);
                    formData.append('status', document.getElementById('status').value);
                    formData.append('campus', document.getElementById('campus').value.trim());
                    formData.append('description', document.getElementById('description').value.trim());

                    if (imageInput.files[0]) {
                        formData.append('image', imageInput.files[0]);
                    }

                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';

                    try {
                        const response = await api.putFormData(`/products/${product.id}`, formData);

                        if (response.success) {
                            showToast('Changes saved successfully!', 'success');
                            setTimeout(() => {
                                window.location.href = `product-details.html?id=${product.id}`;
                            }, 1500);
                        } else {
                            errorText.textContent = response.message || 'Failed to save changes';
                            errorMessage.classList.remove('hidden');
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = '<i class="fas fa-save"></i><span>Save Changes</span>';
                        }
                    } catch (error) {
                        errorText.textContent = error.message || 'An error occurred. Please try again.';
                        errorMessage.classList.remove('hidden');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="fas fa-save"></i><span>Save Changes</span>';
                    }
                });

                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('editContent').classList.remove('hidden');

            } catch (error) {
                console.error('Error loading product:', error);
                showNotFound();
            }
        }

        function showNotFound() {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('notFoundState').classList.remove('hidden');
        }
    </script>
</body>

</html>